---
title: "Andmekvaliteedi hindamine, andmelünkade ja erindite analüüs"
author: "Indrek Soidla"
date: "9 2 2022"
output: 
  html_document:
    theme: spacelab
    highlight: tango
    fig_cap: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (dir.exists("C:/Users/Public/Rstudio_packages")) {
  .libPaths("C:/Users/Public/Rstudio_packages")
}
```

## R Markdown

Laeme sisse vajalikud paketid.

```{r paketid, message = FALSE}
library(haven)
library(foreign)
library(tidyverse)
library(summarytools)
library(naniar)
```

Laeme sisse Euroopa Sotsiaaluuringu Eesti 9. laine andmed (2018).

```{r ess-andmed}
ee9 <- read_sav("data/ESS9EE.sav")
```

Kui Maciga tekib probleeme andmete sisselugemisel või nende töötlemisel, võib proovida andmed sisse lugeda paketiga `foreign`.

```{r ess-andmed-2}
ee9 <- read.spss("data/ESS9EE.sav", to.data.frame = TRUE, use.value.labels = FALSE)
```

Eraldame meile huvipakkuvad tunnused.

```{r andmed}
andmed <- ee9 %>% 
  select(stflife, lrscale, imsmetn, imdfetn, impcntr, imbgeco, imueclt, imwbcnt, rlgdgr, brncntr, gndr, agea, eduyrs)
```

Vaatame andmekirjeldust, et näha, mis tunnused andmestikus on ja millised on nende võimalikud väärtused.

```{r andmekirjeldus}
str(andmed)
```

Kõigi tunnuste peale kokku on andmelünki `sum(is.na(andmed))`. Sellest olulisem on aga teada saada, kui suur on indiviidide osakaal, kellel on vähemalt ühes tunnuses andmelünk.

```{r}
sum(complete.cases(andmed)) # Täielikult mõõdetud indiviidide arv
sum(!complete.cases(andmed)) # Andmelünkadega indiviidide arv ehk indiviidide arv, kellel on vähemalt ühes tunnuses andmelünk
sum(!complete.cases(andmed)) / nrow(andmed) # Andmelünkadega indiviidide osakaal andmestikus
```

Uurime lünklikkust veel lähemalt. Mida näitavad järgnevad kokkuvõtted andmetest?

```{r}
miss_var_summary(andmed)
miss_var_table(andmed)
miss_case_table(andmed)
miss_case_summary(andmed)
```

`naniar` töötab koostöös `dplyr`iga, nii et saame hõlpsalt esitada samu kokkuvõtteid grupiti, nt uurida lünklikkust võrdlevalt meeste ja naiste seas.

```{r}
andmed %>% 
  group_by(gndr) %>% 
  miss_var_summary() %>% 
  print(n = Inf)

andmed %>% 
  group_by(gndr) %>% 
  miss_case_table() %>% 
  print(n = Inf)
```

Pilt ütlevat rohkem kui sada sõna (eeldusel, et oskame pilti adekvaatselt tõlgendada). Teeme siis lünklikkusest kiirema ülevaate saamiseks pilte (st jooniseid).

```{r}
vis_miss(andmed)
gg_miss_var(andmed)
gg_miss_case(andmed)
gg_miss_var(andmed, facet = gndr)
gg_miss_fct(andmed, fct = gndr)
```

Eeltoodud joonised andsid sama info, mis eelnevalt arvuliselt saadud kokkuvõtted. Jooniste suurem ülevaatlikkus tuleb paremini esile siis, kui uurime lünklikkuse mustreid.

```{r}
gg_miss_upset(andmed)
```

Kui palju täielikult mõõdetud indiviide analüüsi n-ö juurde võidaksime, kui jätaksime välja enesepaigutuse vasak-parem-skaalal?

Kui palju võidaksime juurde täielikult mõõdetud indiviide, kui seejärel jätta välja ka teine kõige suurem lünklikkusega tunnus?

```{r}
as_shadow(andmed)
bind_shadow(andmed, only_miss = TRUE)
```

```{r}
andmed %>% 
  bind_shadow() %>% 
  group_by(imbgeco_NA) %>% 
  summarise(mean_stflife = mean(stflife, na.rm = TRUE),
            n_obs = n())
```


Teeme indikaatortunnuse, mis näitab täielike vastustega indiviidide osakaalu andmestikus.

```{r}
andmed <- andmed %>% 
  mutate(valiidne = complete.cases(andmed))
```

Arvutame täisvastustega indiviidide osakaalu.

```{r}
mean(andmed$valiidne)
```

Uurime lünkade juhuslikkust tunnuste lõikes - kas lüngad on soo ja vanuse suhtes täiesti juhuslikud (MCAR) või juhuslikud (MAR)?

```{r}
andmed %>%
  group_by(gndr) %>%
  summarise(valiid_osakaal = mean(valiidne))

andmed %>%
  group_by(valiidne) %>%
  summarise(keskm_vanus = mean(agea))
```

Uurime lünklikkust vanuse suhtes lähemalt, st vanusegrupiti. Loome vanusegrupi tunnuse.

```{r}
andmed$vanusegrupp <- cut(andmed$agea, c(min(andmed$agea), 25, 35, 45, 55, 65, 75, max(andmed$agea)), include.lowest = TRUE)
```

Kontrollime, kas ümberkodeerimine toimis.

```{r}
table(andmed$vanusegrupp)
table(andmed$agea, andmed$vanusegrupp)
```


andmed %>%
  group_by(vanusegrupp) %>%
  summarise(valiid_osakaal = mean(valiidne))

valiid_vanusegrupp <- andmed %>%
  group_by(vanusegrupp) %>%
  summarise(valiid_osakaal = mean(valiidne))

library(ggplot2)
ggplot(valiid_vanusegrupp, aes(x = vanusegrupp, y = valiid_osakaal)) +
  geom_point()

ggplot(valiid_vanusegrupp, aes(x = vanusegrupp, y = valiid_osakaal)) +
  geom_point() +
  ylim(0, 1)

# harjutusülesanne: vahel võib täisvastuste indiviidide osakaalu oluliselt tõsta see, kui ühe või mõne tunnuse analüüsist välja jätame, seda muidugi eeldusel, et see/need konkreetsed tunnused ei ole uurimisküsimuse jaoks kesksel kohal. Milline tunnus kõige rohkem täisvastustega indiviidide arvu n-ö kasvatab, ei saa aga hinnata pelgalt igas üksikus tunnuses esinevate andmelünkade arvu järgi, tuleb uurida lünkade esinemise struktuuri. Kui palju tõuseks iga üksiku tunnuse väljajätmisel täisvastustega indiviidide arv? Millise tunnuse väljajätmisest oleks indiviidide arvu mõttes kõige rohkem kasu? Kas kasu on märgatav, st kas see võiks üles kaaluda infokao tunnuse analüüsist väljajätmise näol?
